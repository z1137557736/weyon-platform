<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.weyon.core.dao.CoreStudentSourceMapper">
  <resultMap id="BaseResultMap" type="com.weyon.core.entity.CoreStudentSource">
    <!--
      WARNING - @mbg.generated
    -->
    <id column="ID" jdbcType="VARCHAR" property="id" />
    <result column="BIND_WECHAT" jdbcType="TINYINT" property="bindWechat" />
    <result column="OPEN_ID" jdbcType="CHAR" property="openId" />
    <result column="SCHOOL_ID" jdbcType="INTEGER" property="schoolId" />
    <result column="GRADUATE_YEAR" jdbcType="SMALLINT" property="graduateYear" />
    <result column="STUDENT_KEY" jdbcType="CHAR" property="studentKey" />
    <result column="XM" jdbcType="VARCHAR" property="xm" />
    <result column="XB" jdbcType="CHAR" property="xb" />
    <result column="XBDM" jdbcType="CHAR" property="xbdm" />
    <result column="SFZH" jdbcType="CHAR" property="sfzh" />
    <result column="MZ" jdbcType="VARCHAR" property="mz" />
    <result column="MZDM" jdbcType="CHAR" property="mzdm" />
    <result column="SYSZDDM" jdbcType="CHAR" property="syszddm" />
    <result column="SYSZD" jdbcType="VARCHAR" property="syszd" />
    <result column="MOBILEPHONE" jdbcType="CHAR" property="mobilephone" />
    <result column="QQ" jdbcType="CHAR" property="qq" />
    <result column="EMAIL" jdbcType="VARCHAR" property="email" />
    <result column="JTDZ" jdbcType="VARCHAR" property="jtdz" />
    <result column="JTDH" jdbcType="VARCHAR" property="jtdh" />
    <result column="JTYB" jdbcType="CHAR" property="jtyb" />
    <result column="KSH" jdbcType="VARCHAR" property="ksh" />
    <result column="KSLBDM" jdbcType="CHAR" property="kslbdm" />
    <result column="KSLB" jdbcType="VARCHAR" property="kslb" />
    <result column="YXDM" jdbcType="CHAR" property="yxdm" />
    <result column="YXMC" jdbcType="VARCHAR" property="yxmc" />
    <result column="XLDM" jdbcType="CHAR" property="xldm" />
    <result column="XL" jdbcType="VARCHAR" property="xl" />
    <result column="XZ" jdbcType="CHAR" property="xz" />
    <result column="SZYX" jdbcType="VARCHAR" property="szyx" />
    <result column="ZYDM" jdbcType="CHAR" property="zydm" />
    <result column="ZY" jdbcType="VARCHAR" property="zy" />
    <result column="ZYFX" jdbcType="VARCHAR" property="zyfx" />
    <result column="SZBJ" jdbcType="VARCHAR" property="szbj" />
    <result column="XH" jdbcType="VARCHAR" property="xh" />
    <result column="RXSJ" jdbcType="CHAR" property="rxsj" />
    <result column="BYSJ" jdbcType="CHAR" property="bysj" />
    <result column="KNSLBDM" jdbcType="CHAR" property="knslbdm" />
    <result column="KNSLB" jdbcType="CHAR" property="knslb" />
    <result column="SFSLBDM" jdbcType="CHAR" property="sfslbdm" />
    <result column="SFSLB" jdbcType="CHAR" property="sfslb" />
    <result column="PYFSDM" jdbcType="CHAR" property="pyfsdm" />
    <result column="PYFS" jdbcType="CHAR" property="pyfs" />
    <result column="ZXWYDM" jdbcType="CHAR" property="zxwydm" />
    <result column="ZXWY" jdbcType="VARCHAR" property="zxwy" />
    <result column="DASFZRXX" jdbcType="TINYINT" property="dasfzrxx" />
    <result column="HKSFZRXX" jdbcType="TINYINT" property="hksfzrxx" />
    <result column="RXQDASZDW" jdbcType="VARCHAR" property="rxqdaszdw" />
    <result column="RXQHKSZDPCS" jdbcType="VARCHAR" property="rxqhkszdpcs" />
    <result column="DXHWPDW" jdbcType="VARCHAR" property="dxhwpdw" />
    <result column="CXSY" jdbcType="VARCHAR" property="cxsy" />
    <result column="AUDIT_STATUS" jdbcType="TINYINT" property="auditStatus" />
    <result column="AUDIT_CONTENT" jdbcType="VARCHAR" property="auditContent" />
    <result column="AUDIT_DATE" jdbcType="TIMESTAMP" property="auditDate" />
    <result column="AUDITOR_ID" jdbcType="VARCHAR" property="auditorId" />
    <result column="UNBIND_IMG_URL" jdbcType="VARCHAR" property="unbindImgUrl" />
    <result column="UNBIND_CONTENT" jdbcType="VARCHAR" property="unbindContent" />
    <result column="KZZD1" jdbcType="VARCHAR" property="kzzd1" />
    <result column="KZZD2" jdbcType="VARCHAR" property="kzzd2" />
    <result column="KZZD3" jdbcType="VARCHAR" property="kzzd3" />
    <result column="KZZD4" jdbcType="VARCHAR" property="kzzd4" />
    <result column="KZZD5" jdbcType="VARCHAR" property="kzzd5" />
    <result column="KZZD6" jdbcType="VARCHAR" property="kzzd6" />
    <result column="KZZD7" jdbcType="VARCHAR" property="kzzd7" />
    <result column="KZZD8" jdbcType="VARCHAR" property="kzzd8" />
    <result column="CHECK_PHONE_UPDATE" jdbcType="TINYINT" property="checkPhoneUpdate" />
    <result column="CHECK_UPDATE" jdbcType="TINYINT" property="checkUpdate" />
    <result column="CHECK_DATE" jdbcType="TIMESTAMP" property="checkDate" />
    <result column="CREATOR_ID" jdbcType="VARCHAR" property="creatorId" />
    <result column="CREATOR" jdbcType="VARCHAR" property="creator" />
    <result column="CREATE_DATE" jdbcType="TIMESTAMP" property="createDate" />
    <result column="UPDATE_DATE" jdbcType="TIMESTAMP" property="updateDate" />
  </resultMap>

  <select id="selectSzyxZy" resultType="map">
    select t.szyx name,t.zy,t.xl,CONCAT(t.zy,'（',substr(t.xl, 1, 1),'）') label from tb_core_student_source t
    <if test="yxdm != 0">
      where t.yxdm = #{yxdm}
    </if>
    group by t.szyx,t.xl,t.zy
    order by t.szyx
  </select>

  <select id="selectXlList" resultType="map">
    select distinct t.xl from tb_core_student_source t
    <where>
      <if test="yxdm != 0">
        and t.yxdm = #{yxdm}
      </if>
      <if test="zy != null and zy !=''">
        and t.zy = #{zy}
      </if>
    </where>
  </select>

  <select id="selectZyList" resultType="map">
    select distinct t.zy from tb_core_student_source t
    <where>
      <if test="yxdm != 0">
        and t.yxdm = #{yxdm}
      </if>
      <if test="zy != null and zy !=''">
        and t.xl = #{xl}
      </if>
    </where>
  </select>

  <insert id="saveBatch"  parameterType="com.weyon.core.entity.CoreStudentSource">
    INSERT INTO tb_core_student_source  (
    ID,BIND_WECHAT,OPEN_ID,SCHOOL_ID,GRADUATE_YEAR,STUDENT_KEY,XM,XB,XBDM,SFZH,MZ,MZDM,SYSZDDM,SYSZD,
    MOBILEPHONE,QQ,EMAIL,JTDZ,JTDH,JTYB,KSH,KSLBDM,KSLB,YXDM,YXMC,XLDM,XL,XZ,SZYX,ZYDM,ZY,ZYFX,
    SZBJ,XH,RXSJ,BYSJ,KNSLBDM,KNSLB,SFSLBDM,SFSLB,PYFSDM,PYFS,ZXWYDM,ZXWY,DASFZRXX,HKSFZRXX,RXQDASZDW,
    RXQHKSZDPCS,DXHWPDW,CXSY,AUDIT_STATUS,AUDIT_CONTENT,AUDIT_DATE,AUDITOR_ID,UNBIND_IMG_URL,UNBIND_CONTENT,
    KZZD1,KZZD2,KZZD3,KZZD4,KZZD5,KZZD6,KZZD7,KZZD8,CHECK_UPDATE,CHECK_DATE,CREATOR_ID,CREATOR
    )VALUES
    <foreach collection="list" index="index" item="item" separator=",">
      ((SELECT REPLACE(UUID(),'-','') AS ID),#{item.bindWechat},#{item.openId},#{item.schoolId},#{item.graduateYear},#{item.studentKey},#{item.xm},#{item.xb},#{item.xbdm},#{item.sfzh},#{item.mz}
      ,#{item.mzdm},#{item.syszddm},#{item.syszd},#{item.mobilephone},#{item.qq},#{item.email},#{item.jtdz},#{item.jtdh},#{item.jtyb},#{item.ksh},#{item.kslbdm}
      ,#{item.kslb},#{item.yxdm},#{item.yxmc},#{item.xldm},#{item.xl},#{item.xz},#{item.szyx},#{item.zydm},#{item.zy},#{item.zyfx},#{item.szbj}
      ,#{item.xh} ,#{item.rxsj} ,#{item.bysj} ,#{item.knslbdm} ,#{item.knslb} ,#{item.sfslbdm} ,#{item.sfslb} ,#{item.pyfsdm} ,#{item.pyfs} ,#{item.zxwydm}
      ,#{item.zxwy},#{item.dasfzrxx},#{item.hksfzrxx},#{item.rxqdaszdw},#{item.rxqhkszdpcs},#{item.dxhwpdw},#{item.cxsy},#{item.auditStatus}
      ,#{item.auditContent},#{item.auditDate},#{item.auditorId},#{item.unbindImgUrl},#{item.unbindContent},#{item.kzzd1},#{item.kzzd2}
      ,#{item.kzzd3},#{item.kzzd4},#{item.kzzd5},#{item.kzzd6},#{item.kzzd7},#{item.kzzd8},#{item.checkUpdate},#{item.checkDate},#{item.creatorId}
      ,#{item.creator}
      )
    </foreach>
  </insert>

  <update id="updateBatch" parameterType="com.weyon.core.entity.CoreStudentSource">

    <foreach collection="list" index="index" item="item" separator=",">
      UPDATE tb_core_student_source
      <set>
        BIND_WECHAT = #{item.bindWechat},OPEN_ID = #{item.openId},SCHOOL_ID = #{item.schoolId},
        GRADUATE_YEAR = #{item.graduateYear},XM = #{item.xm}, XB = #{item.xb}, XBDM = #{item.xbdm}, SFZH = #{item.sfzh}, MZ = #{item.mz}
        ,MZDM = #{item.mzdm}, SYSZDDM = #{item.syszddm}, SYSZD = #{item.syszd}, MOBILEPHONE = #{item.mobilephone}, QQ = #{item.qq}, EMAIL = #{item.email}, JTDZ = #{item.jtdz}, JTDH = #{item.jtdh},JTYB = #{item.jtyb}, KSH = #{item.ksh}, KSLBDM = #{item.kslbdm}
        ,KSLB = #{item.kslb}, YXDM = #{item.yxdm}, YXMC = #{item.yxmc}, XLDM = #{item.xldm}, XL = #{item.xl}, XZ = #{item.xz}, SZYX = #{item.szyx}, ZYDM = #{item.zydm}, ZY = #{item.zy}, ZYFX = #{item.zyfx}, SZBJ = #{item.szbj}
        ,XH = #{item.xh} , RXSJ = #{item.rxsj} , BYSJ = #{item.bysj} , KNSLBDM = #{item.knslbdm} , KNSLB = #{item.knslb} , SFSLBDM = #{item.sfslbdm} , SFSLB = #{item.sfslb} , PYFSDM = #{item.pyfsdm} , PYFS = #{item.pyfs} , ZXWYDM = #{item.zxwydm}
        ,ZXWY = #{item.zxwy}, DASFZRXX = #{item.dasfzrxx}, HKSFZRXX = #{item.hksfzrxx}, RXQDASZDW = #{item.rxqdaszdw}, RXQHKSZDPCS = #{item.rxqhkszdpcs}, DXHWPDW = #{item.dxhwpdw}, CXSY = #{item.cxsy}, AUDIT_STATUS = #{item.auditStatus}
        ,AUDIT_CONTENT = #{item.auditContent}, AUDIT_DATE = #{item.auditDate}, AUDITOR_ID = #{item.auditorId}, UNBIND_IMG_URL = #{item.unbindImgUrl}, UNBIND_CONTENT = #{item.unbindContent}, KZZD1 = #{item.kzzd1}, KZZD2 = #{item.kzzd2}
        ,KZZD3 = #{item.kzzd3}, KZZD4 = #{item.kzzd4}, KZZD5 = #{item.kzzd5}, KZZD6 = #{item.kzzd6}, KZZD7 = #{item.kzzd7}, KZZD8 = #{item.kzzd8}, CHECK_UPDATE =  #{item.checkUpdate}, CHECK_DATE = #{item.checkDate}
      </set>
      <where>
        ID = #{item.id}
      </where>
    </foreach>
  </update>

  <select id="selectStatistics" parameterType="com.weyon.core.entity.CoreStudentSource" resultType="com.alibaba.fastjson.JSONObject">
    SELECT
    COUNT(1) AS 'sampleNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    COUNT(CASE WHEN BIND_WECHAT =1 AND AUDIT_STATUS = 0 THEN 1 ELSE NULL END ) AS 'noCheckNum',
    COUNT(CASE WHEN BIND_WECHAT !=1 THEN 1 ELSE NULL END ) AS 'noAuthenticationNum',
    concat(ROUND(COUNT(CASE WHEN AUDIT_STATUS >= 1 THEN 1 ELSE NULL END )/COUNT(1)*100, 2),' %') AS  'checkProportion',
    YXMC
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm !=''">
        YXDM = #{yxdm}
      </if>
      <if test="szyx != null and szyx !=''">
        AND  SZYX = #{szyx}
      </if>
      <if test="zy != null and zy !=''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl !=''">
        AND XL = #{xl}
      </if>
    </where>
    GROUP BY
    YXMC
    <if test="zy != null and zy !=''">
      ,ZY
    </if>
    <if test="xl != null and xl !=''">
      ,XL
    </if>
    <if test="szyx != null and szyx !=''">
      ,SZYX
    </if>
    ORDER BY checkProportion DESC
  </select>
  <!--根据专业统计生源信息-->
  <select id="statisticsByZY" parameterType="com.weyon.core.entity.CoreStudentSource" resultType="com.alibaba.fastjson.JSONObject">
    SELECT
    ZY,
    COUNT(1) AS 'sampleNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    COUNT(CASE WHEN BIND_WECHAT =1 AND AUDIT_STATUS = 0 THEN 1 ELSE NULL END ) AS 'noCheckNum',
    COUNT(CASE WHEN BIND_WECHAT !=1 THEN 1 ELSE NULL END ) AS 'noAuthenticationNum',
    concat(ROUND(COUNT(CASE WHEN AUDIT_STATUS >= 1 THEN 1 ELSE NULL END )/COUNT(1)*100, 2),' %') AS  'checkProportion'
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm != ''">
        YXDM = #{yxdm}
      </if>
      <if test="zy != null and zy != ''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl != ''">
        AND XL = #{xl}
      </if>
    </where>

    GROUP BY ZY
    ORDER BY checkProportion DESC
  </select>


  <select id="statisticsByXL" parameterType="com.weyon.core.entity.CoreStudentSource" resultType="com.alibaba.fastjson.JSONObject">
    SELECT
    XL,
    COUNT(1) AS 'sampleNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    COUNT(CASE WHEN BIND_WECHAT =1 AND AUDIT_STATUS = 0 THEN 1 ELSE NULL END ) AS 'noCheckNum',
    COUNT(CASE WHEN BIND_WECHAT !=1 THEN 1 ELSE NULL END ) AS 'noAuthenticationNum',
    concat(ROUND(COUNT(CASE WHEN AUDIT_STATUS >= 1 THEN 1 ELSE NULL END )/COUNT(1)*100, 2),' %') AS  'checkProportion'
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm != ''">
        YXDM = #{yxdm}
      </if>
      <if test="zy != null and zy != ''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl != ''">
        AND XL = #{xl}
      </if>
    </where>

    GROUP BY XL
    ORDER BY checkProportion DESC
  </select>


  <!--错误生源信息统计-->
  <select id="selectErrorStatistics" parameterType="com.alibaba.fastjson.JSONObject" resultType="java.util.Map">
    SELECT
    YXMC,
    COUNT(CASE WHEN CHECK_UPDATE = 1  THEN 1 ELSE NULL END) AS 'errorNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    concat(ROUND(COUNT(CASE WHEN CHECK_UPDATE >= 1 THEN 1 ELSE NULL END )/COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END )*100, 2),' %') AS  'errorProportion'
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm !=''">
        YXDM = #{yxdm}
      </if>
      <if test="szyx != null and szyx !=''">
        AND  SZYX = #{szyx}
      </if>
      <if test="zy != null and zy !=''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl !=''">
        AND XL = #{xl}
      </if>
    </where>
    GROUP BY YXMC
    <if test="zy != null and zy !=''">
      ,ZY
    </if>
    <if test="xl != null and xl !=''">
      ,XL
    </if>
    <if test="szyx != null and szyx !=''">
      ,SZYX
    </if>
    order by errorProportion desc
  </select>

  <!--按照专业统计生源错误信息-->
  <select id="errorStatisticsByZY" resultType="java.util.Map" parameterType="com.alibaba.fastjson.JSONObject">
    SELECT
    ZY,
    COUNT(CASE WHEN CHECK_UPDATE = 1  THEN 1 ELSE NULL END) AS 'errorNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    concat(
    case when COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END) = 0 then 0.00 else
    ROUND(COUNT(CASE WHEN CHECK_UPDATE >= 1 THEN 1 ELSE NULL END )/COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END )*100, 2) end,' %') AS  'errorProportion'
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm != ''">
        YXDM = #{yxdm}
      </if>
      <if test="zy != null and zy != ''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl != ''">
        AND XL = #{xl}
      </if>
    </where>
    GROUP BY ZY
    order by errorProportion desc
  </select>

  <!--按照学历统计错误生源信息-->
  <select id="errorStatisticsByXL" resultType="java.util.Map" parameterType="com.alibaba.fastjson.JSONObject">
    SELECT
    XL,
    COUNT(CASE WHEN CHECK_UPDATE = 1  THEN 1 ELSE NULL END) AS 'errorNum',
    COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END ) AS 'checkNum',
    concat(
    case when COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END) = 0 then 0.00 else
    ROUND(COUNT(CASE WHEN CHECK_UPDATE >= 1 THEN 1 ELSE NULL END )/COUNT(CASE WHEN AUDIT_STATUS >= 1  THEN 1 ELSE NULL END )*100, 2) end,' %') AS  'errorProportion'
    FROM
    tb_core_student_source
    <where>
      <if test="yxdm != null and yxdm != ''">
        YXDM = #{yxdm}
      </if>
      <if test="zy != null and zy != ''">
        AND ZY = #{zy}
      </if>
      <if test="xl != null and xl != ''">
        AND XL = #{xl}
      </if>
    </where>
    GROUP BY XL
    order by errorProportion desc
  </select>
</mapper>
